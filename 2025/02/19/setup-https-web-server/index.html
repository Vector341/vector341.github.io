<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>搭建支持 HTTPS 的网站 | vector 的博客</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="在运行 Ubuntu 的云主机上搭建一个网站并完成 HTTPS 签名

准备工作

一台拥有公网 IP 的云主机。（这里以 Amazon EC2 为例）
一个域名（配置解析到上面的公网 IP）

正式开始

搭建 web 服务器

想要获取证书完成签名流程，首先需要一个正常工作的 web 服务器。使用 Apache 默认配置即可

获取证书

[LetsE ...">
    
    <link rel="preload" href="/assets/css/0.styles.d98ac11d.css" as="style"><link rel="preload" href="/assets/js/app.ff098235.js" as="script"><link rel="preload" href="/assets/js/4.8ec4f70b.js" as="script"><link rel="preload" href="/assets/js/1.12ba3317.js" as="script"><link rel="preload" href="/assets/js/19.6829269c.js" as="script"><link rel="prefetch" href="/assets/js/11.bbe46144.js"><link rel="prefetch" href="/assets/js/12.feb38c55.js"><link rel="prefetch" href="/assets/js/13.da59f2bf.js"><link rel="prefetch" href="/assets/js/14.106eba89.js"><link rel="prefetch" href="/assets/js/15.f1877751.js"><link rel="prefetch" href="/assets/js/16.a32b1f42.js"><link rel="prefetch" href="/assets/js/17.57c2c54b.js"><link rel="prefetch" href="/assets/js/18.fc3a30d0.js"><link rel="prefetch" href="/assets/js/2.6a63e167.js"><link rel="prefetch" href="/assets/js/20.9aa3688e.js"><link rel="prefetch" href="/assets/js/21.1886fb6e.js"><link rel="prefetch" href="/assets/js/22.658da7ef.js"><link rel="prefetch" href="/assets/js/3.4b8460b2.js"><link rel="prefetch" href="/assets/js/5.08307592.js"><link rel="prefetch" href="/assets/js/6.31eac88d.js"><link rel="prefetch" href="/assets/js/7.3cfed19d.js"><link rel="prefetch" href="/assets/js/8.308d9af2.js"><link rel="prefetch" href="/assets/js/vuejs-paginate.a73f878b.js">
    <link rel="stylesheet" href="/assets/css/0.styles.d98ac11d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-blog__global-layout"><section id="header-wrapper"><header id="header"><div class="header-wrapper"><div class="title"><a href="/" class="nav-link home-link">vector 的博客 </a></div> <div class="header-right-wrap"><!----> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></div></header></section> <div id="mobile-header"><div class="mobile-header-bar"><div class="mobile-header-title"><a href="/" class="nav-link mobile-home-link">vector 的博客 </a> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></div> <div class="mobile-menu-wrapper"><hr class="menu-divider"> <!----></div></div></div> <div class="content-wrapper"><div id="vuepress-theme-blog__post-layout"><article itemscope="itemscope" itemtype="https://schema.org/BlogPosting" class="vuepress-blog-theme-content"><header><h1 itemprop="name headline" class="post-title">
        搭建支持 HTTPS 的网站
      </h1> <div class="post-meta"><!----> <!----> <!----></div></header> <div itemprop="articleBody" class="content__default"><p>在运行 Ubuntu 的云主机上搭建一个网站并完成 HTTPS 签名</p> <h3 id="准备工作"><a href="#准备工作" class="header-anchor">#</a> 准备工作</h3> <ul><li>一台拥有公网 IP 的云主机。（这里以 Amazon EC2 为例）</li> <li>一个域名（配置解析到上面的公网 IP）</li></ul> <h2 id="正式开始"><a href="#正式开始" class="header-anchor">#</a> 正式开始</h2> <h3 id="搭建-web-服务器"><a href="#搭建-web-服务器" class="header-anchor">#</a> 搭建 web 服务器</h3> <p>想要获取证书完成签名流程，首先需要一个正常工作的 web 服务器。使用 Apache 默认配置即可</p> <h3 id="获取证书"><a href="#获取证书" class="header-anchor">#</a> 获取证书</h3> <p><a href="https://letsencrypt.org/" target="_blank" rel="noopener noreferrer">LetsEncrypt<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 提供免费的 SSL 证书，它借助 ACME 协议完成域名签名。支持 ACME 的客户端有很多，这里以</p> <p><a href="https://github.com/acmesh-official/acme.sh" target="_blank" rel="noopener noreferrer"><code>acme.sh</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 为例。</p> <p>确保 apache 服务器正常运行，执行以下命令在 staging 环境中测试配置的正确性：</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">sudo</span> acme.sh <span class="token parameter variable">--issue</span> <span class="token parameter variable">--server</span> letsencrypt <span class="token parameter variable">--test</span> <span class="token parameter variable">-d</span> vector341.com <span class="token parameter variable">-w</span> /var/www/html <span class="token parameter variable">--keylength</span> ec-256
</code></pre></div><p>执行这个命令后，服务器上的 acme agent 会首先生成一对密钥，保存私钥后将公钥发送给 Let's Encrypt 的服务器。Let's Encrypt 服务器会返回一个 nonce，agent 使用私钥签名后放入 web 服务器的根目录下。之后，Let's Encrypt 访问你提供的域名，用公钥确认 nonce 以及签名的正确性。</p> <p>在 staging 环境测试完成后即可正式签名：</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">sudo</span> acme.sh <span class="token parameter variable">--issue</span> <span class="token parameter variable">--server</span> letsencrypt <span class="token parameter variable">-d</span> vector341.com <span class="token parameter variable">-w</span> /var/www/html <span class="token parameter variable">--keylength</span> ec-256 <span class="token parameter variable">--force</span>

</code></pre></div><h4 id="工作原理"><a href="#工作原理" class="header-anchor">#</a> 工作原理</h4> <p>Let's Encrypt 使用 ACME 协议来证明一个服务器确实拥有这个域名，上述的创建资源是一种证明方法，详细的交互步骤见：https://letsencrypt.org/how-it-works/</p> <h3 id="安装证书"><a href="#安装证书" class="header-anchor">#</a> 安装证书</h3> <p>将证书、私钥和证书链安装到指定位置，在 Ubuntu 中通常是 <code>/etc/ssl/certs</code></p> <div class="language-sh extra-class"><pre class="language-sh"><code>acme.sh <span class="token parameter variable">--installcert</span> <span class="token parameter variable">-d</span> vector341.com --cert-file /etc/ssl/certs/letsencrypt-cert.crt --key-file /etc/ssl/private/letsencrypt-cert.key --fullchain-file /etc/apache2/ssl.crt/letsencrypt-fullchain.crt <span class="token parameter variable">--ecc</span>
</code></pre></div><h3 id="配置-https-服务器"><a href="#配置-https-服务器" class="header-anchor">#</a> 配置 https 服务器</h3> <p>以 apache 的默认 ssl 配置 <code>/etc/apache2/site-available/default-ssl.conf</code> 为例，修改以下三项的配置：</p> <div class="language-sh extra-class"><pre class="language-sh"><code>        <span class="token comment">#   A self-signed (snakeoil) certificate can be created by installing</span>
        <span class="token comment">#   the ssl-cert package. See</span>
        <span class="token comment">#   /usr/share/doc/apache2/README.Debian.gz for more info.</span>
        <span class="token comment">#   If both key and certificate are stored in the same file, only the</span>
        <span class="token comment">#   SSLCertificateFile directive is needed.</span>
        SSLCertificateFile      /etc/ssl/certs/letsencrypt-cert.crt
        SSLCertificateKeyFile   /etc/ssl/private/letsencrypt-cert.key

        <span class="token comment">#   Server Certificate Chain:</span>
        <span class="token comment">#   Point SSLCertificateChainFile at a file containing the</span>
        <span class="token comment">#   concatenation of PEM encoded CA certificates which form the</span>
        <span class="token comment">#   certificate chain for the server certificate. Alternatively</span>
        <span class="token comment">#   the referenced file can be the same as SSLCertificateFile</span>
        <span class="token comment">#   when the CA certificates are directly appended to the server</span>
        <span class="token comment">#   certificate for convinience.</span>
        SSLCertificateChainFile /etc/apache2/ssl.crt/letsencrypt-fullchain.crt
</code></pre></div><p>修改配置后启用 ssl 模块和 virtual host，重启 apache2 即可：</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">sudo</span> a2enmod ssl
<span class="token function">sudo</span> a2ensite default-ssl.conf
<span class="token function">sudo</span> systemctl restart apache2
</code></pre></div><blockquote><p>其实这里也提示了可以用 ssl-cert 生成自签名的证书：</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">sudo</span> make-ssl-cert generate-default-snakeoil
</code></pre></div><p>生成的私钥位于：<code>/etc/ssl/private/ssl-cert-snakeoil.key</code>
生成的证书：<code>/etc/ssl/certs/ssl-cert-snakeoil.pem</code></p></blockquote> <h2 id="ssl-签名与加密的原理"><a href="#ssl-签名与加密的原理" class="header-anchor">#</a> SSL 签名与加密的原理</h2> <p>在密码学中，签名与加密是一对互逆的过程：</p> <ul><li>签名：使用私钥与原始数据运算得到签名，使用公钥验证数据完整性（integrity）</li> <li>加密：使用公钥与原始数据运算得到密文，使用密钥确保数据私密性（encryption）</li></ul> <p>其中原始数据一般是文件的哈希值，签名时公钥常被包含在原始文件中一起签名。</p> <h3 id="详细过程"><a href="#详细过程" class="header-anchor">#</a> 详细过程</h3> <p>OpenSSL 库提供了丰富的工具，我们可以实际探究签名或加密的过程</p> <h4 id="_1-生成私钥"><a href="#_1-生成私钥" class="header-anchor">#</a> 1. 生成私钥</h4> <p>私钥用于对数据进行签名。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>
openssl genpkey <span class="token parameter variable">-algorithm</span> RSA <span class="token parameter variable">-out</span> private_key.pem
</code></pre></div><h4 id="_2-提取公钥"><a href="#_2-提取公钥" class="header-anchor">#</a> 2. 提取公钥</h4> <p>用私钥生成公钥，用于签名验证。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>
openssl rsa <span class="token parameter variable">-in</span> private_key.pem <span class="token parameter variable">-pubout</span> <span class="token parameter variable">-out</span> public_key.pem
</code></pre></div><h4 id="_3-创建示例数据文件"><a href="#_3-创建示例数据文件" class="header-anchor">#</a> 3.创建示例数据文件</h4> <p>创建一个包含要签名数据的简单文本文件。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>
<span class="token builtin class-name">echo</span> <span class="token string">&quot;Hello, this is a test message.&quot;</span> <span class="token operator">&gt;</span> data.txt
</code></pre></div><h4 id="_4-对数据文件进行签名"><a href="#_4-对数据文件进行签名" class="header-anchor">#</a> 4.对数据文件进行签名</h4> <p>使用私钥创建签名。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>
openssl dgst <span class="token parameter variable">-sha256</span> <span class="token parameter variable">-sign</span> private_key.pem <span class="token parameter variable">-out</span> signature.bin data.txt
</code></pre></div><p>参数说明：</p> <ul><li><code>-sha256</code>：指定哈希函数，一般签名是针对文件的哈希值</li></ul> <p>signature.bin 即是文件 data.txt 的签名</p> <h4 id="_5-验证签名"><a href="#_5-验证签名" class="header-anchor">#</a> 5.验证签名</h4> <p>OpenSSL 提供了工具用于验证签名</p> <div class="language- extra-class"><pre class="language-text"><code>openssl dgst -sha256 -verify public_key.pem -signature signature.bin data.txt
</code></pre></div><p>我们也可以参考验证的步骤手动完成上述步骤，更好地理解如何验证签名。</p> <ol><li>使用相同的哈希算法（SHA-256）对原始数据文件 (<code>data.txt</code>) 进行哈希计算。</li></ol> <div class="language- extra-class"><pre class="language-text"><code>$ sha256sum data.txt
21dae1f57aab6196019a38338f4270afa4060461725c852a07fccf735f80c28d  data.txt
</code></pre></div><ol start="2"><li>使用<strong>公钥</strong>解密 <code>signature.bin</code> 以获取原始哈希值。</li></ol> <div class="language- extra-class"><pre class="language-text"><code>$ openssl rsautl -verify -inkey public_key.pem -pubin -in signature.bin -out decrypted.bin
</code></pre></div><ol start="3"><li>如果<strong>两个哈希值匹配</strong>，则数据被验证为真实且未被篡改。</li></ol> <div class="language- extra-class"><pre class="language-text"><code>$ tail -c 32 decrypted.bin &gt; extracted_hash.bin
$ hexdump -C extracted_hash.bin
00000000  21 da e1 f5 7a ab 61 96  01 9a 38 33 8f 42 70 af  |!...z.a...83.Bp.|
00000010  a4 06 04 61 72 5c 85 2a  07 fc cf 73 5f 80 c2 8d  |...ar\.*...s_...|
00000020
</code></pre></div><p>RSA 签名使用的哈希结果为 32 字节，<code>tail -c 32</code> 用于去除解密数据中的 <strong>ASN.1 Header</strong>，提取最后 32 字节的哈希值</p> <h2 id="参考"><a href="#参考" class="header-anchor">#</a> 参考</h2> <ol><li>Mozilla 的一个网站，用于生成现代的 HTTPS 配置：https://ssl-config.mozilla.org/</li> <li>同样是 Mozilla 的网站，用于评价 HTTPS 网站的安全性：https://developer.mozilla.org/en-US/observatory</li> <li>SSL 证书信任链的工作原理：https://knowledge.digicert.com/solution/how-certificate-chains-work</li></ol></div> <footer><!----> <hr> <!----></footer></article> <div class="sticker vuepress-toc"><div class="vuepress-toc-item vuepress-toc-h3 active"><a href="#准备工作" title="准备工作">准备工作</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#正式开始" title="正式开始">正式开始</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#搭建-web-服务器" title="搭建 web 服务器">搭建 web 服务器</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#获取证书" title="获取证书">获取证书</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#安装证书" title="安装证书">安装证书</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#配置-https-服务器" title="配置 https 服务器">配置 https 服务器</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#ssl-签名与加密的原理" title="SSL 签名与加密的原理">SSL 签名与加密的原理</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#详细过程" title="详细过程">详细过程</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#参考" title="参考">参考</a></div></div></div></div> <footer class="footer" data-v-3d9deeb8><div class="footer-left-wrap" data-v-3d9deeb8><ul class="contact" data-v-3d9deeb8></ul></div> <div class="footer-right-wrap" data-v-3d9deeb8><ul class="copyright" data-v-3d9deeb8></ul></div></footer></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.ff098235.js" defer></script><script src="/assets/js/4.8ec4f70b.js" defer></script><script src="/assets/js/1.12ba3317.js" defer></script><script src="/assets/js/19.6829269c.js" defer></script>
  </body>
</html>
